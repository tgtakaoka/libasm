/*
 * Copyright 2022 Tadashi G. Takaoka
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include "dis_i8096.h"
#include "test_dis_helper.h"

using namespace libasm;
using namespace libasm::i8096;
using namespace libasm::test;

#define ONAL(name, opr, at, ...) ERRT(name, opr, OPERAND_NOT_ALIGNED, at, __VA_ARGS__)

DisI8096 dis8096;
Disassembler &disassembler(dis8096);

bool is8096() {
    return strcasecmp_P("8096", dis8096.cpu_P()) == 0;
}

bool is80196() {
    return strcasecmp_P("80196", dis8096.cpu_P()) == 0;
}

void set_up() {
    disassembler.reset();
}

void tear_down() {
    symtab.reset();
}

// clang-format off
void test_cpu() {
    EQUALS("cpu 8096", true,   disassembler.setCpu("8096"));
    EQUALS_P("cpu 8096", "8096", disassembler.config().cpu_P());

    EQUALS("cpu i8096", true,   disassembler.setCpu("i8096"));
    EQUALS_P("cpu i8096", "8096", disassembler.config().cpu_P());

    EQUALS("cpu 80196", true,   disassembler.setCpu("80196"));
    EQUALS_P("cpu 80196", "80196", disassembler.config().cpu_P());

    EQUALS("cpu i80196", true,   disassembler.setCpu("i80196"));
    EQUALS_P("cpu i80196", "80196", disassembler.config().cpu_P());
}

void test_2_operands() {
    TEST("ADD", "52, 32",           0x64, 0x20, 0x34);
    ONAL("ADD", "53, 32", "53, 32", 0x64, 0x20, 0x35);
    ONAL("ADD", "52, 19",     "19", 0x64, 0x13, 0x34);
    TEST("ADD", "86, #3412H",               0x65, 0x12, 0x34, 0x56);
    ONAL("ADD", "87, #3412H", "87, #3412H", 0x65, 0x12, 0x34, 0x57);
    TEST("ADD", "52, [32]",             0x66, 0x20, 0x34);
    ONAL("ADD", "53, [32]", "53, [32]", 0x66, 0x20, 0x35);
    TEST("ADD", "52, [32]+",            0x66, 0x21, 0x34);
    TEST("ADD", "86, 52[32]",               0x67, 0x20, 0x34, 0x56);
    TEST("ADD", "86, 53[32]",               0x67, 0x20, 0x35, 0x56);
    TEST("ADD", "86, 52[0]",                0x67, 0x00, 0x34, 0x56);
    ONAL("ADD", "86, 53[0]",       "53[0]", 0x67, 0x00, 0x35, 0x56);
    ONAL("ADD", "87, 52[32]", "87, 52[32]", 0x67, 0x20, 0x34, 0x57);
    TEST("ADD", "120, 5634H[32]",                   0x67, 0x21, 0x34, 0x56, 0x78);
    TEST("ADD", "120, 5635H[32]",                   0x67, 0x21, 0x35, 0x56, 0x78);
    TEST("ADD", "120, 5634H[0]",                    0x67, 0x01, 0x34, 0x56, 0x78);
    ONAL("ADD", "120, 5635H[0]",        "5635H[0]", 0x67, 0x01, 0x35, 0x56, 0x78);
    ONAL("ADD", "121, 5634H[32]", "121, 5634H[32]", 0x67, 0x21, 0x34, 0x56, 0x79);
    TEST("ADD", "16, 32", 0x64, 0x20, 0x10);
    TEST("ADD", "52, 16", 0x64, 0x10, 0x34);

    ERRT("ADD", "52, [22]",      ILLEGAL_REGISTER, "[22]", 0x66, 0x16, 0x34);
    ERRT("ADD", "52, [2]+",      ILLEGAL_REGISTER, "[2]+", 0x66, 0x03, 0x34);
    ERRT("ADD", "52, 32[22]",    ILLEGAL_REGISTER, "[22]", 0x67, 0x16, 0x20, 0x34);
    ERRT("ADD", "52, 5678H[22]", ILLEGAL_REGISTER, "[22]", 0x67, 0x17, 0x78, 0x56, 0x34);

    TEST("ADDB", "35, 32",        0x74, 0x20, 0x23);
    TEST("ADDB", "34, 33",        0x74, 0x21, 0x22);
    TEST("ADDB", "35, #32",       0x75, 0x20, 0x23);
    TEST("ADDB", "35, [32]",      0x76, 0x20, 0x23);
    TEST("ADDB", "35, [32]+",     0x76, 0x21, 0x23);
    TEST("ADDB", "52, 35[32]",    0x77, 0x20, 0x23, 0x34);
    TEST("ADDB", "53, 35[32]",    0x77, 0x20, 0x23, 0x35);
    TEST("ADDB", "69, 3423H[32]", 0x77, 0x21, 0x23, 0x34, 0x45);

    TEST("ADDC", "52, 32",         0xA4, 0x20, 0x34);
    TEST("ADDC", "86, #3412H",     0xA5, 0x12, 0x34, 0x56);
    TEST("ADDC", "52, [32]",       0xA6, 0x20, 0x34);
    TEST("ADDC", "52, [32]+",      0xA6, 0x21, 0x34);
    TEST("ADDC", "86, 52[32]",     0xA7, 0x20, 0x34, 0x56);
    TEST("ADDC", "120, 5634H[32]", 0xA7, 0x21, 0x34, 0x56, 0x78);

    TEST("ADDCB", "35, 32",        0xB4, 0x20, 0x23);
    TEST("ADDCB", "35, #32",       0xB5, 0x20, 0x23);
    TEST("ADDCB", "35, [32]",      0xB6, 0x20, 0x23);
    TEST("ADDCB", "35, [32]+",     0xB6, 0x21, 0x23);
    TEST("ADDCB", "52, 35[32]",    0xB7, 0x20, 0x23, 0x34);
    TEST("ADDCB", "69, 3423H[32]", 0xB7, 0x21, 0x23, 0x34, 0x45);

    TEST("SUB", "52, 32",         0x68, 0x20, 0x34);
    TEST("SUB", "86, #3412H",     0x69, 0x12, 0x34, 0x56);
    TEST("SUB", "52, [32]",       0x6A, 0x20, 0x34);
    TEST("SUB", "52, [32]+",      0x6A, 0x21, 0x34);
    TEST("SUB", "86, 52[32]",     0x6B, 0x20, 0x34, 0x56);
    TEST("SUB", "120, 5634H[32]", 0x6B, 0x21, 0x34, 0x56, 0x78);

    TEST("SUBB", "35, 32",        0x78, 0x20, 0x23);
    TEST("SUBB", "35, #32",       0x79, 0x20, 0x23);
    TEST("SUBB", "35, [32]",      0x7A, 0x20, 0x23);
    TEST("SUBB", "35, [32]+",     0x7A, 0x21, 0x23);
    TEST("SUBB", "52, 35[32]",    0x7B, 0x20, 0x23, 0x34);
    TEST("SUBB", "69, 3423H[32]", 0x7B, 0x21, 0x23, 0x34, 0x45);

    TEST("SUBC", "52, 32",         0xA8, 0x20, 0x34);
    TEST("SUBC", "86, #3412H",     0xA9, 0x12, 0x34, 0x56);
    TEST("SUBC", "52, [32]",       0xAA, 0x20, 0x34);
    TEST("SUBC", "52, [32]+",      0xAA, 0x21, 0x34);
    TEST("SUBC", "86, 52[32]",     0xAB, 0x20, 0x34, 0x56);
    TEST("SUBC", "120, 5634H[32]", 0xAB, 0x21, 0x34, 0x56, 0x78);

    TEST("SUBCB", "35, 32",        0xB8, 0x20, 0x23);
    TEST("SUBCB", "35, #32",       0xB9, 0x20, 0x23);
    TEST("SUBCB", "35, [32]",      0xBA, 0x20, 0x23);
    TEST("SUBCB", "35, [32]+",     0xBA, 0x21, 0x23);
    TEST("SUBCB", "52, 35[32]",    0xBB, 0x20, 0x23, 0x34);
    TEST("SUBCB", "69, 3423H[32]", 0xBB, 0x21, 0x23, 0x34, 0x45);

    TEST("CMP", "52, 32",         0x88, 0x20, 0x34);
    TEST("CMP", "86, #3412H",     0x89, 0x12, 0x34, 0x56);
    TEST("CMP", "52, [32]",       0x8A, 0x20, 0x34);
    TEST("CMP", "52, [32]+",      0x8A, 0x21, 0x34);
    TEST("CMP", "86, 52[32]",     0x8B, 0x20, 0x34, 0x56);
    TEST("CMP", "120, 5634H[32]", 0x8B, 0x21, 0x34, 0x56, 0x78);

    TEST("CMPB", "35, 32",        0x98, 0x20, 0x23);
    TEST("CMPB", "35, #32",       0x99, 0x20, 0x23);
    TEST("CMPB", "35, [32]",      0x9A, 0x20, 0x23);
    TEST("CMPB", "35, [32]+",     0x9A, 0x21, 0x23);
    TEST("CMPB", "52, 35[32]",    0x9B, 0x20, 0x23, 0x34);
    TEST("CMPB", "69, 3423H[32]", 0x9B, 0x21, 0x23, 0x34, 0x45);

    if (is80196()) {
        TEST("CMPL", "52, 32", 0xC5, 0x20, 0x34);
    }

    TEST("MUL", "52, 32",           0xFE, 0x6C, 0x20, 0x34);
    ONAL("MUL", "52, 33",     "33", 0xFE, 0x6C, 0x21, 0x34);
    ONAL("MUL", "53, 32", "53, 32", 0xFE, 0x6C, 0x20, 0x35);
    ONAL("MUL", "54, 32", "54, 32", 0xFE, 0x6C, 0x20, 0x36);
    ONAL("MUL", "55, 32", "55, 32", 0xFE, 0x6C, 0x20, 0x37);
    TEST("MUL", "84, #3412H",               0xFE, 0x6D, 0x12, 0x34, 0x54);
    ONAL("MUL", "85, #3412H", "85, #3412H", 0xFE, 0x6D, 0x12, 0x34, 0x55);
    ONAL("MUL", "86, #3412H", "86, #3412H", 0xFE, 0x6D, 0x12, 0x34, 0x56);
    ONAL("MUL", "87, #3412H", "87, #3412H", 0xFE, 0x6D, 0x12, 0x34, 0x57);
    TEST("MUL", "52, [32]",             0xFE, 0x6E, 0x20, 0x34);
    TEST("MUL", "52, [32]+",            0xFE, 0x6E, 0x21, 0x34);
    ONAL("MUL", "53, [32]", "53, [32]", 0xFE, 0x6E, 0x20, 0x35);
    ONAL("MUL", "54, [32]", "54, [32]", 0xFE, 0x6E, 0x20, 0x36);
    ONAL("MUL", "55, [32]", "55, [32]", 0xFE, 0x6E, 0x20, 0x37);
    TEST("MUL", "84, 52[32]",               0xFE, 0x6F, 0x20, 0x34, 0x54);
    ONAL("MUL", "85, 52[32]", "85, 52[32]", 0xFE, 0x6F, 0x20, 0x34, 0x55);
    ONAL("MUL", "86, 52[32]", "86, 52[32]", 0xFE, 0x6F, 0x20, 0x34, 0x56);
    ONAL("MUL", "87, 52[32]", "87, 52[32]", 0xFE, 0x6F, 0x20, 0x34, 0x57);
    TEST("MUL", "120, 5634H[32]",                   0xFE, 0x6F, 0x21, 0x34, 0x56, 0x78);
    ONAL("MUL", "121, 5634H[32]", "121, 5634H[32]", 0xFE, 0x6F, 0x21, 0x34, 0x56, 0x79);
    ONAL("MUL", "122, 5634H[32]", "122, 5634H[32]", 0xFE, 0x6F, 0x21, 0x34, 0x56, 0x7A);
    ONAL("MUL", "123, 5634H[32]", "123, 5634H[32]", 0xFE, 0x6F, 0x21, 0x34, 0x56, 0x7B);
    ERRT("MUL", "16, 32",     ILLEGAL_REGISTER, "16, 32",     0xFE, 0x6C, 0x20, 0x10);
    ERRT("MUL", "52, 16",     ILLEGAL_REGISTER, "16",         0xFE, 0x6C, 0x10, 0x34);
    ERRT("MUL", "16, #3412H", ILLEGAL_REGISTER, "16, #3412H", 0xFE, 0x6D, 0x12, 0x34, 0x10);
    ERRT("MUL", "16, [32]+",  ILLEGAL_REGISTER, "16, [32]+",  0xFE, 0x6E, 0x21, 0x10);
    ERRT("MUL", "16, 52[32]", ILLEGAL_REGISTER, "16, 52[32]", 0xFE, 0x6F, 0x20, 0x34, 0x10);

    TEST("MULB", "36, 33",           0xFE, 0x7C, 0x21, 0x24);
    ONAL("MULB", "37, 32", "37, 32", 0xFE, 0x7C, 0x20, 0x25);
    TEST("MULB", "36, #32",            0xFE, 0x7D, 0x20, 0x24);
    ONAL("MULB", "37, #32", "37, #32", 0xFE, 0x7D, 0x20, 0x25);
    TEST("MULB", "36, [32]",             0xFE, 0x7E, 0x20, 0x24);
    TEST("MULB", "36, [32]+"       ,     0xFE, 0x7E, 0x21, 0x24);
    ONAL("MULB", "37, [32]", "37, [32]", 0xFE, 0x7E, 0x20, 0x25);
    TEST("MULB", "52, 35[32]",               0xFE, 0x7F, 0x20, 0x23, 0x34);
    ONAL("MULB", "53, 35[32]", "53, 35[32]", 0xFE, 0x7F, 0x20, 0x23, 0x35);
    TEST("MULB", "70, 3423H[32]",                  0xFE, 0x7F, 0x21, 0x23, 0x34, 0x46);
    ONAL("MULB", "71, 3423H[32]", "71, 3423H[32]", 0xFE, 0x7F, 0x21, 0x23, 0x34, 0x47);
    ERRT("MULB", "16, 33", ILLEGAL_REGISTER, "16, 33", 0xFE, 0x7C, 0x21, 0x10);
    ERRT("MULB", "36, 16", ILLEGAL_REGISTER, "16",     0xFE, 0x7C, 0x10, 0x24);

    TEST("MULU", "52, 32",         0x6C, 0x20, 0x34);
    TEST("MULU", "84, #3412H",     0x6D, 0x12, 0x34, 0x54);
    TEST("MULU", "52, [32]",       0x6E, 0x20, 0x34);
    TEST("MULU", "52, [32]+",      0x6E, 0x21, 0x34);
    TEST("MULU", "84, 52[32]",     0x6F, 0x20, 0x34, 0x54);
    TEST("MULU", "120, 5634H[32]", 0x6F, 0x21, 0x34, 0x56, 0x78);
    ERRT("MULU", "16, 32", ILLEGAL_REGISTER, "16, 32", 0x6C, 0x20, 0x10);
    ERRT("MULU", "52, 16", ILLEGAL_REGISTER, "16",     0x6C, 0x10, 0x34);

    TEST("MULUB", "36, 32",        0x7C, 0x20, 0x24);
    TEST("MULUB", "36, #32",       0x7D, 0x20, 0x24);
    TEST("MULUB", "36, [32]",      0x7E, 0x20, 0x24);
    TEST("MULUB", "36, [32]+",     0x7E, 0x21, 0x24);
    TEST("MULUB", "52, 35[32]",    0x7F, 0x20, 0x23, 0x34);
    TEST("MULUB", "70, 3423H[32]", 0x7F, 0x21, 0x23, 0x34, 0x46);
    ERRT("MULUB", "16, 33", ILLEGAL_REGISTER, "16, 33", 0x7C, 0x21, 0x10);
    ERRT("MULUB", "36, 16", ILLEGAL_REGISTER, "16",     0x7C, 0x10, 0x24);

    TEST("DIV", "52, 32",         0xFE, 0x8C, 0x20, 0x34);
    TEST("DIV", "84, #3412H",     0xFE, 0x8D, 0x12, 0x34, 0x54);
    TEST("DIV", "52, [32]",       0xFE, 0x8E, 0x20, 0x34);
    TEST("DIV", "52, [32]+",      0xFE, 0x8E, 0x21, 0x34);
    TEST("DIV", "84, 52[32]",     0xFE, 0x8F, 0x20, 0x34, 0x54);
    TEST("DIV", "120, 5634H[32]",                   0xFE, 0x8F, 0x21, 0x34, 0x56, 0x78);
    ONAL("DIV", "121, 5634H[32]", "121, 5634H[32]", 0xFE, 0x8F, 0x21, 0x34, 0x56, 0x79);
    ONAL("DIV", "122, 5634H[32]", "122, 5634H[32]", 0xFE, 0x8F, 0x21, 0x34, 0x56, 0x7A);
    ONAL("DIV", "123, 5634H[32]", "123, 5634H[32]", 0xFE, 0x8F, 0x21, 0x34, 0x56, 0x7B);
    ERRT("DIV", "16, 32", ILLEGAL_REGISTER, "16, 32", 0xFE, 0x8C, 0x20, 0x10);
    ERRT("DIV", "52, 16", ILLEGAL_REGISTER, "16",     0xFE, 0x8C, 0x10, 0x34);

    TEST("DIVB", "36, 33",        0xFE, 0x9C, 0x21, 0x24);
    TEST("DIVB", "36, #32",       0xFE, 0x9D, 0x20, 0x24);
    TEST("DIVB", "36, [32]",      0xFE, 0x9E, 0x20, 0x24);
    TEST("DIVB", "36, [32]+",     0xFE, 0x9E, 0x21, 0x24);
    TEST("DIVB", "52, 35[32]",    0xFE, 0x9F, 0x20, 0x23, 0x34);
    TEST("DIVB", "70, 3423H[32]", 0xFE, 0x9F, 0x21, 0x23, 0x34, 0x46);
    ERRT("DIVB", "16, 33", ILLEGAL_REGISTER, "16, 33", 0xFE, 0x9C, 0x21, 0x10);
    ERRT("DIVB", "36, 16", ILLEGAL_REGISTER, "16",     0xFE, 0x9C, 0x10, 0x24);

    TEST("DIVU", "52, 32",           0x8C, 0x20, 0x34);
    ONAL("DIVU", "52, 33",     "33", 0x8C, 0x21, 0x34);
    ONAL("DIVU", "53, 32", "53, 32", 0x8C, 0x20, 0x35);
    ONAL("DIVU", "54, 32", "54, 32", 0x8C, 0x20, 0x36);
    ONAL("DIVU", "55, 32", "55, 32", 0x8C, 0x20, 0x37);
    TEST("DIVU", "84, #3412H",               0x8D, 0x12, 0x34, 0x54);
    ONAL("DIVU", "85, #3412H", "85, #3412H", 0x8D, 0x12, 0x34, 0x55);
    ONAL("DIVU", "86, #3412H", "86, #3412H", 0x8D, 0x12, 0x34, 0x56);
    ONAL("DIVU", "87, #3412H", "87, #3412H", 0x8D, 0x12, 0x34, 0x57);
    TEST("DIVU", "52, [32]",             0x8E, 0x20, 0x34);
    TEST("DIVU", "52, [32]+",            0x8E, 0x21, 0x34);
    ONAL("DIVU", "53, [32]", "53, [32]", 0x8E, 0x20, 0x35);
    ONAL("DIVU", "54, [32]", "54, [32]", 0x8E, 0x20, 0x36);
    ONAL("DIVU", "55, [32]", "55, [32]", 0x8E, 0x20, 0x37);
    TEST("DIVU", "84, 52[32]",               0x8F, 0x20, 0x34, 0x54);
    ONAL("DIVU", "85, 52[32]", "85, 52[32]", 0x8F, 0x20, 0x34, 0x55);
    ONAL("DIVU", "86, 52[32]", "86, 52[32]", 0x8F, 0x20, 0x34, 0x56);
    ONAL("DIVU", "87, 52[32]", "87, 52[32]", 0x8F, 0x20, 0x34, 0x57);
    TEST("DIVU", "120, 5634H[32]",                   0x8F, 0x21, 0x34, 0x56, 0x78);
    ONAL("DIVU", "121, 5634H[32]", "121, 5634H[32]", 0x8F, 0x21, 0x34, 0x56, 0x79);
    ONAL("DIVU", "122, 5634H[32]", "122, 5634H[32]", 0x8F, 0x21, 0x34, 0x56, 0x7A);
    ONAL("DIVU", "123, 5634H[32]", "123, 5634H[32]", 0x8F, 0x21, 0x34, 0x56, 0x7B);
    ERRT("DIVU", "16, 32", ILLEGAL_REGISTER, "16, 32", 0x8C, 0x20, 0x10);
    ERRT("DIVU", "52, 16", ILLEGAL_REGISTER, "16",     0x8C, 0x10, 0x34);

    TEST("DIVUB", "36, 33",           0x9C, 0x21, 0x24);
    ONAL("DIVUB", "37, 32", "37, 32", 0x9C, 0x20, 0x25);
    TEST("DIVUB", "36, #32",            0x9D, 0x20, 0x24);
    ONAL("DIVUB", "37, #32", "37, #32", 0x9D, 0x20, 0x25);
    TEST("DIVUB", "36, [32]",             0x9E, 0x20, 0x24);
    TEST("DIVUB", "36, [32]+"       ,     0x9E, 0x21, 0x24);
    ONAL("DIVUB", "37, [32]", "37, [32]", 0x9E, 0x20, 0x25);
    TEST("DIVUB", "52, 35[32]",               0x9F, 0x20, 0x23, 0x34);
    ONAL("DIVUB", "53, 35[32]", "53, 35[32]", 0x9F, 0x20, 0x23, 0x35);
    TEST("DIVUB", "70, 3423H[32]",                  0x9F, 0x21, 0x23, 0x34, 0x46);
    ONAL("DIVUB", "71, 3423H[32]", "71, 3423H[32]", 0x9F, 0x21, 0x23, 0x34, 0x47);
    ERRT("DIVUB", "16, 33", ILLEGAL_REGISTER, "16, 33", 0x9C, 0x21, 0x10);
    ERRT("DIVUB", "36, 16", ILLEGAL_REGISTER, "16",     0x9C, 0x10, 0x24);

    TEST("AND", "52, 32",         0x60, 0x20, 0x34);
    TEST("AND", "86, #3412H",     0x61, 0x12, 0x34, 0x56);
    TEST("AND", "52, [32]",       0x62, 0x20, 0x34);
    TEST("AND", "52, [32]+",      0x62, 0x21, 0x34);
    TEST("AND", "86, 52[32]",     0x63, 0x20, 0x34, 0x56);
    TEST("AND", "120, 5634H[32]", 0x63, 0x21, 0x34, 0x56, 0x78);

    TEST("ANDB", "35, 32",        0x70, 0x20, 0x23);
    TEST("ANDB", "35, #32",       0x71, 0x20, 0x23);
    TEST("ANDB", "35, [32]",      0x72, 0x20, 0x23);
    TEST("ANDB", "35, [32]+",     0x72, 0x21, 0x23);
    TEST("ANDB", "52, 35[32]",    0x73, 0x20, 0x23, 0x34);
    TEST("ANDB", "69, 3423H[32]", 0x73, 0x21, 0x23, 0x34, 0x45);

    TEST("OR", "52, 32",         0x80, 0x20, 0x34);
    TEST("OR", "86, #3412H",     0x81, 0x12, 0x34, 0x56);
    TEST("OR", "52, [32]",       0x82, 0x20, 0x34);
    TEST("OR", "52, [32]+",      0x82, 0x21, 0x34);
    TEST("OR", "86, 52[32]",     0x83, 0x20, 0x34, 0x56);
    TEST("OR", "120, 5634H[32]", 0x83, 0x21, 0x34, 0x56, 0x78);

    TEST("ORB", "35, 32",        0x90, 0x20, 0x23);
    TEST("ORB", "35, #32",       0x91, 0x20, 0x23);
    TEST("ORB", "35, [32]",      0x92, 0x20, 0x23);
    TEST("ORB", "35, [32]+",     0x92, 0x21, 0x23);
    TEST("ORB", "52, 35[32]",    0x93, 0x20, 0x23, 0x34);
    TEST("ORB", "69, 3423H[32]", 0x93, 0x21, 0x23, 0x34, 0x45);

    TEST("XOR", "52, 32",         0x84, 0x20, 0x34);
    TEST("XOR", "86, #3412H",     0x85, 0x12, 0x34, 0x56);
    TEST("XOR", "52, [32]",       0x86, 0x20, 0x34);
    TEST("XOR", "52, [32]+",      0x86, 0x21, 0x34);
    TEST("XOR", "86, 52[32]",     0x87, 0x20, 0x34, 0x56);
    TEST("XOR", "120, 5634H[32]", 0x87, 0x21, 0x34, 0x56, 0x78);

    TEST("XORB", "35, 32",        0x94, 0x20, 0x23);
    TEST("XORB", "35, #32",       0x95, 0x20, 0x23);
    TEST("XORB", "35, [32]",      0x96, 0x20, 0x23);
    TEST("XORB", "35, [32]+",     0x96, 0x21, 0x23);
    TEST("XORB", "52, 35[32]",    0x97, 0x20, 0x23, 0x34);
    TEST("XORB", "69, 3423H[32]", 0x97, 0x21, 0x23, 0x34, 0x45);
}

void test_3_operands() {
    TEST("ADD", "86, 52, 32",          0x44, 0x20, 0x34, 0x56);
    TEST("ADD", "120, 86, #3412H",     0x45, 0x12, 0x34, 0x56, 0x78);
    TEST("ADD", "86, 52, [32]",        0x46, 0x20, 0x34, 0x56);
    TEST("ADD", "86, 52, [32]+",       0x46, 0x21, 0x34, 0x56);
    TEST("ADD", "120, 86, 52[32]",     0x47, 0x20, 0x34, 0x56, 0x78);
    TEST("ADD", "154, 120, 5634H[32]", 0x47, 0x21, 0x34, 0x56, 0x78, 0x9A);

    TEST("ADDB", "52, 35, 32",        0x54, 0x20, 0x23, 0x34);
    TEST("ADDB", "52, 35, #32",       0x55, 0x20, 0x23, 0x34);
    TEST("ADDB", "52, 35, [32]",      0x56, 0x20, 0x23, 0x34);
    TEST("ADDB", "52, 35, [32]+",     0x56, 0x21, 0x23, 0x34);
    TEST("ADDB", "69, 52, 35[32]",    0x57, 0x20, 0x23, 0x34, 0x45);
    TEST("ADDB", "86, 69, 3423H[32]", 0x57, 0x21, 0x23, 0x34, 0x45, 0x56);

    TEST("SUB", "86, 52, 32",          0x48, 0x20, 0x34, 0x56);
    TEST("SUB", "120, 86, #3412H",     0x49, 0x12, 0x34, 0x56, 0x78);
    TEST("SUB", "86, 52, [32]",        0x4A, 0x20, 0x34, 0x56);
    TEST("SUB", "86, 52, [32]+",       0x4A, 0x21, 0x34, 0x56);
    TEST("SUB", "120, 86, 52[32]",     0x4B, 0x20, 0x34, 0x56, 0x78);
    TEST("SUB", "154, 120, 5634H[32]", 0x4B, 0x21, 0x34, 0x56, 0x78, 0x9A);

    TEST("SUBB", "52, 35, 32",         0x58, 0x20, 0x23, 0x34);
    TEST("SUBB", "52, 35, #32",        0x59, 0x20, 0x23, 0x34);
    TEST("SUBB", "52, 35, [32]",       0x5A, 0x20, 0x23, 0x34);
    TEST("SUBB", "52, 35, [32]+",      0x5A, 0x21, 0x23, 0x34);
    TEST("SUBB", "69, 52, 35[32]",     0x5B, 0x20, 0x23, 0x34, 0x45);
    TEST("SUBB",  "86, 69, 3423H[32]", 0x5B, 0x21, 0x23, 0x34, 0x45, 0x56);

    TEST("MUL", "84, 52, 32",          0xFE, 0x4C, 0x20, 0x34, 0x54);
    TEST("MUL", "120, 86, #3412H",     0xFE, 0x4D, 0x12, 0x34, 0x56, 0x78);
    TEST("MUL", "84, 52, [32]",        0xFE, 0x4E, 0x20, 0x34, 0x54);
    TEST("MUL", "84, 52, [32]+",       0xFE, 0x4E, 0x21, 0x34, 0x54);
    TEST("MUL", "120, 86, 52[32]",     0xFE, 0x4F, 0x20, 0x34, 0x56, 0x78);
    TEST("MUL", "152, 120, 5634H[32]", 0xFE, 0x4F, 0x21, 0x34, 0x56, 0x78, 0x98);
    ERRT("MUL", "16, 52, 32",
         ILLEGAL_REGISTER, "16, 52, 32",     0xFE, 0x4C, 0x20, 0x34, 0x10);
    ERRT("MUL", "84, 16, 32",
         ILLEGAL_REGISTER, "16, 32",         0xFE, 0x4C, 0x20, 0x10, 0x54);
    ERRT("MUL", "84, 52, 16",
         ILLEGAL_REGISTER, "16",             0xFE, 0x4C, 0x10, 0x34, 0x54);
    ERRT("MUL", "16, 86, #3412H",
         ILLEGAL_REGISTER, "16, 86, #3412H", 0xFE, 0x4D, 0x12, 0x34, 0x56, 0x10);
    ERRT("MUL", "120, 16, #3412H",
         ILLEGAL_REGISTER, "16, #3412H",     0xFE, 0x4D, 0x12, 0x34, 0x10, 0x78);
    ERRT("MUL", "16, 52, [32]",
         ILLEGAL_REGISTER, "16, 52, [32]",   0xFE, 0x4E, 0x20, 0x34, 0x10);
    ERRT("MUL", "84, 16, [32]+",
         ILLEGAL_REGISTER, "16, [32]+",      0xFE, 0x4E, 0x21, 0x10, 0x54);
    ERRT("MUL", "16, 86, 52[32]",
         ILLEGAL_REGISTER, "16, 86, 52[32]", 0xFE, 0x4F, 0x20, 0x34, 0x56, 0x10);
    ERRT("MUL", "120, 16, 52[32]",
         ILLEGAL_REGISTER, "16, 52[32]",     0xFE, 0x4F, 0x20, 0x34, 0x10, 0x78);

    TEST("MULB", "52, 35, 32",        0xFE, 0x5C, 0x20, 0x23, 0x34);
    TEST("MULB", "52, 35, #32",       0xFE, 0x5D, 0x20, 0x23, 0x34);
    TEST("MULB", "52, 35, [32]",      0xFE, 0x5E, 0x20, 0x23, 0x34);
    TEST("MULB", "52, 35, [32]+",     0xFE, 0x5E, 0x21, 0x23, 0x34);
    TEST("MULB", "70, 52, 35[32]",    0xFE, 0x5F, 0x20, 0x23, 0x34, 0x46);
    TEST("MULB", "86, 69, 3423H[32]", 0xFE, 0x5F, 0x21, 0x23, 0x34, 0x45, 0x56);
    ERRT("MULB", "16, 52, 32",
         ILLEGAL_REGISTER, "16, 52, 32", 0xFE, 0x5C, 0x20, 0x34, 0x10);
    ERRT("MULB", "84, 16, 32",
         ILLEGAL_REGISTER, "16, 32",     0xFE, 0x5C, 0x20, 0x10, 0x54);
    ERRT("MULB", "84, 52, 16",
         ILLEGAL_REGISTER, "16",         0xFE, 0x5C, 0x10, 0x34, 0x54);

    TEST("MULU", "84, 52, 32",               0x4C, 0x20, 0x34, 0x54);
    ONAL("MULU", "84, 52, 33",         "33", 0x4C, 0x21, 0x34, 0x54);
    ONAL("MULU", "84, 53, 32",     "53, 32", 0x4C, 0x20, 0x35, 0x54);
    ONAL("MULU", "85, 52, 32", "85, 52, 32", 0x4C, 0x20, 0x34, 0x55);
    ONAL("MULU", "86, 52, 32", "86, 52, 32", 0x4C, 0x20, 0x34, 0x56);
    ONAL("MULU", "87, 52, 32", "87, 52, 32", 0x4C, 0x20, 0x34, 0x57);
    TEST("MULU", "120, 86, #3412H",                    0x4D, 0x12, 0x34, 0x56, 0x78);
    ONAL("MULU", "120, 87, #3412H",      "87, #3412H", 0x4D, 0x12, 0x34, 0x57, 0x78);
    ONAL("MULU", "121, 86, #3412H", "121, 86, #3412H", 0x4D, 0x12, 0x34, 0x56, 0x79);
    ONAL("MULU", "122, 86, #3412H", "122, 86, #3412H", 0x4D, 0x12, 0x34, 0x56, 0x7A);
    ONAL("MULU", "123, 86, #3412H", "123, 86, #3412H", 0x4D, 0x12, 0x34, 0x56, 0x7B);
    TEST("MULU", "84, 52, [32]",                 0x4E, 0x20, 0x34, 0x54);
    TEST("MULU", "84, 52, [32]+",                0x4E, 0x21, 0x34, 0x54);
    ONAL("MULU", "84, 53, [32]",     "53, [32]", 0x4E, 0x20, 0x35, 0x54);
    ONAL("MULU", "85, 52, [32]", "85, 52, [32]", 0x4E, 0x20, 0x34, 0x55);
    ONAL("MULU", "86, 52, [32]", "86, 52, [32]", 0x4E, 0x20, 0x34, 0x56);
    ONAL("MULU", "87, 52, [32]", "87, 52, [32]", 0x4E, 0x20, 0x34, 0x57);
    TEST("MULU", "120, 86, 52[32]",                    0x4F, 0x20, 0x34, 0x56, 0x78);
    ONAL("MULU", "120, 87, 52[32]",      "87, 52[32]", 0x4F, 0x20, 0x34, 0x57, 0x78);
    ONAL("MULU", "121, 86, 52[32]", "121, 86, 52[32]", 0x4F, 0x20, 0x34, 0x56, 0x79);
    ONAL("MULU", "122, 86, 52[32]", "122, 86, 52[32]", 0x4F, 0x20, 0x34, 0x56, 0x7A);
    ONAL("MULU", "123, 86, 52[32]", "123, 86, 52[32]", 0x4F, 0x20, 0x34, 0x56, 0x7B);
    TEST("MULU", "152, 120, 5634H[32]", 0x4F, 0x21, 0x34, 0x56, 0x78, 0x98);
    ONAL("MULU", "152, 121, 5634H[32]",
         "121, 5634H[32]",              0x4F, 0x21, 0x34, 0x56, 0x79, 0x98);
    ONAL("MULU", "153, 120, 5634H[32]",
         "153, 120, 5634H[32]",         0x4F, 0x21, 0x34, 0x56, 0x78, 0x99);
    ONAL("MULU", "154, 120, 5634H[32]",
         "154, 120, 5634H[32]",         0x4F, 0x21, 0x34, 0x56, 0x78, 0x9A);
    ONAL("MULU", "155, 120, 5634H[32]",
         "155, 120, 5634H[32]",         0x4F, 0x21, 0x34, 0x56, 0x78, 0x9B);
    ERRT("MULU", "16, 52, 32",
         ILLEGAL_REGISTER, "16, 52, 32", 0x4C, 0x20, 0x34, 0x10);
    ERRT("MULU", "84, 16, 32",
         ILLEGAL_REGISTER, "16, 32",     0x4C, 0x20, 0x10, 0x54);
    ERRT("MULU", "84, 52, 16",
         ILLEGAL_REGISTER, "16",         0x4C, 0x10, 0x34, 0x54);

    TEST("MULUB", "52, 36, 33",               0x5C, 0x21, 0x24, 0x34);
    TEST("MULUB", "52, 35, 32",               0x5C, 0x20, 0x23, 0x34);
    ONAL("MULUB", "53, 36, 32", "53, 36, 32", 0x5C, 0x20, 0x24, 0x35);
    TEST("MULUB", "52, 35, #32",                0x5D, 0x20, 0x23, 0x34);
    ONAL("MULUB", "53, 35, #32", "53, 35, #32", 0x5D, 0x20, 0x23, 0x35);
    TEST("MULUB", "52, 35, [32]",                 0x5E, 0x20, 0x23, 0x34);
    TEST("MULUB", "52, 35, [32]+",                0x5E, 0x21, 0x23, 0x34);
    ONAL("MULUB", "53, 35, [32]", "53, 35, [32]", 0x5E, 0x20, 0x23, 0x35);
    TEST("MULUB", "70, 53, 35[32]",                   0x5F, 0x20, 0x23, 0x35, 0x46);
    ONAL("MULUB", "71, 53, 35[32]", "71, 53, 35[32]", 0x5F, 0x20, 0x23, 0x35, 0x47);
    TEST("MULUB", "86, 69, 3423H[32]",                      0x5F, 0x21, 0x23, 0x34, 0x45, 0x56);
    ONAL("MULUB", "87, 69, 3423H[32]", "87, 69, 3423H[32]", 0x5F, 0x21, 0x23, 0x34, 0x45, 0x57);
    ERRT("MULUB", "16, 52, 32",
         ILLEGAL_REGISTER, "16, 52, 32", 0x5C, 0x20, 0x34, 0x10);
    ERRT("MULUB", "84, 16, 32",
         ILLEGAL_REGISTER, "16, 32",     0x5C, 0x20, 0x10, 0x54);
    ERRT("MULUB", "84, 52, 16",
         ILLEGAL_REGISTER, "16",         0x5C, 0x10, 0x34, 0x54);

    TEST("AND", "86, 52, 32",          0x40, 0x20, 0x34, 0x56);
    TEST("AND", "120, 86, #3412H",     0x41, 0x12, 0x34, 0x56, 0x78);
    TEST("AND", "86, 52, [32]",        0x42, 0x20, 0x34, 0x56);
    TEST("AND", "86, 52, [32]+",       0x42, 0x21, 0x34, 0x56);
    TEST("AND", "120, 86, 52[32]",     0x43, 0x20, 0x34, 0x56, 0x78);
    TEST("AND", "154, 120, 5634H[32]", 0x43, 0x21, 0x34, 0x56, 0x78, 0x9A);

    TEST("ANDB", "52, 35, 32",        0x50, 0x20, 0x23, 0x34);
    TEST("ANDB", "52, 35, #32",       0x51, 0x20, 0x23, 0x34);
    TEST("ANDB", "52, 35, [32]",      0x52, 0x20, 0x23, 0x34);
    TEST("ANDB", "52, 35, [32]+",     0x52, 0x21, 0x23, 0x34);
    TEST("ANDB", "69, 52, 35[32]",    0x53, 0x20, 0x23, 0x34, 0x45);
    TEST("ANDB", "86, 69, 3423H[32]", 0x53, 0x21, 0x23, 0x34, 0x45, 0x56);
}

void test_move() {
    TEST("LD", "52, 32",         0xA0, 0x20, 0x34);
    TEST("LD", "86, #3412H",     0xA1, 0x12, 0x34, 0x56);
    TEST("LD", "52, [32]",       0xA2, 0x20, 0x34);
    TEST("LD", "52, [32]+",      0xA2, 0x21, 0x34);
    TEST("LD", "86, 52[32]",     0xA3, 0x20, 0x34, 0x56);
    TEST("LD", "120, 5634H[32]", 0xA3, 0x21, 0x34, 0x56, 0x78);

    TEST("LDB", "35, 32",           0xB0, 0x20, 0x23);
    TEST("LDB", "35, #32",          0xB1, 0x20, 0x23);
    TEST("LDB", "35, [32]",         0xB2, 0x20, 0x23);
    TEST("LDB", "35, [32]+",        0xB2, 0x21, 0x23);
    TEST("LDB", "236, -19[254]",    0xB3, 0xFE, 0xED, 0xEC);
    TEST("LDB", "235, 0ECEDH[254]", 0xB3, 0xFF, 0xED, 0xEC, 0xEB);

    TEST("ST", "52, 32",           0xC0, 0x20, 0x34);
    if (is8096()) {
        UNKN(0xC1);
    } else {
        TEST("BMOV", "52, 32", 0xC1, 0x20, 0x34);
    }
    TEST("ST", "52, [32]",         0xC2, 0x20, 0x34);
    TEST("ST", "52, [32]+",        0xC2, 0x21, 0x34);
    TEST("ST", "86, 52[32]",       0xC3, 0x20, 0x34, 0x56);
    TEST("ST", "120, 5634H[32]",   0xC3, 0x21, 0x34, 0x56, 0x78);

    TEST("STB", "35, 32",           0xC4, 0x20, 0x23);
    if (is8096()) {
        UNKN(0xC5);
    } else {
        TEST("CMPL", "52, 32", 0xC5, 0x20, 0x34);
    }
    TEST("STB", "35, [32]",         0xC6, 0x20, 0x23);
    TEST("STB", "35, [32]+",        0xC6, 0x21, 0x23);
    TEST("STB", "236, -19[254]",    0xC7, 0xFE, 0xED, 0xEC);
    TEST("STB", "235, 0ECEDH[254]", 0xC7, 0xFF, 0xED, 0xEC, 0xEB);

    TEST("LDBSE", "52, 33",           0xBC, 0x21, 0x34);
    ONAL("LDBSE", "53, 33", "53, 33", 0xBC, 0x21, 0x35);
    TEST("LDBSE", "52, #32",            0xBD, 0x20, 0x34);
    ONAL("LDBSE", "53, #32", "53, #32", 0xBD, 0x20, 0x35);
    TEST("LDBSE", "52, [32]",             0xBE, 0x20, 0x34);
    TEST("LDBSE", "52, [32]+",            0xBE, 0x21, 0x34);
    ONAL("LDBSE", "53, [32]", "53, [32]", 0xBE, 0x20, 0x35);
    TEST("LDBSE", "86, 52[32]",               0xBF, 0x20, 0x34, 0x56);
    ONAL("LDBSE", "87, 52[32]", "87, 52[32]", 0xBF, 0x20, 0x34, 0x57);
    TEST("LDBSE", "120, 5634H[32]",                   0xBF, 0x21, 0x34, 0x56, 0x78);
    ONAL("LDBSE", "121, 5634H[32]", "121, 5634H[32]", 0xBF, 0x21, 0x34, 0x56, 0x79);

    TEST("LDBZE", "52, 33",         0xAC, 0x21, 0x34);
    TEST("LDBZE", "52, #32",        0xAD, 0x20, 0x34);
    TEST("LDBZE", "52, [32]",       0xAE, 0x20, 0x34);
    TEST("LDBZE", "52, [32]+",      0xAE, 0x21, 0x34);
    TEST("LDBZE", "86, 52[32]",     0xAF, 0x20, 0x34, 0x56);
    TEST("LDBZE", "120, 5634H[32]", 0xAF, 0x21, 0x34, 0x56, 0x78);

    TEST("PUSH", "32",       0xC8, 0x20);
    ONAL("PUSH", "33", "33", 0xC8, 0x21);
    TEST("PUSH", "#3412H",   0xC9, 0x12, 0x34);
    TEST("PUSH", "[32]",         0xCA, 0x20);
    TEST("PUSH", "[32]+",        0xCA, 0x21);
    TEST("PUSH", "52[32]",         0xCB, 0x20, 0x34);
    TEST("PUSH", "53[32]",         0xCB, 0x20, 0x35);
    TEST("PUSH", "52[0]",          0xCB, 0x00, 0x34);
    ONAL("PUSH", "53[0]", "53[0]", 0xCB, 0x00, 0x35);
    TEST("PUSH", "5634H[32]",            0xCB, 0x21, 0x34, 0x56);
    TEST("PUSH", "5635H[32]",            0xCB, 0x21, 0x35, 0x56);
    TEST("PUSH", "5634H[0]",             0xCB, 0x01, 0x34, 0x56);
    ONAL("PUSH", "5635H[0]", "5635H[0]", 0xCB, 0x01, 0x35, 0x56);

    TEST("POP", "32",       0xCC, 0x20);
    ONAL("POP", "33", "33", 0xCC, 0x21);
    if (is8096()) {
        UNKN(0xCD);
    } else {
        TEST("BMOVI", "52, 32", 0xCD, 0x20, 0x34);
    }
    TEST("POP", "[32]",         0xCE, 0x20);
    TEST("POP", "[32]+",        0xCE, 0x21);
    TEST("POP", "52[32]",         0xCF, 0x20, 0x34);
    TEST("POP", "53[32]",         0xCF, 0x20, 0x35);
    TEST("POP", "52[0]",          0xCF, 0x00, 0x34);
    ONAL("POP", "53[0]", "53[0]", 0xCF, 0x00, 0x35);
    TEST("POP", "5634H[32]",            0xCF, 0x21, 0x34, 0x56);
    TEST("POP", "5635H[32]",            0xCF, 0x21, 0x35, 0x56);
    TEST("POP", "5634H[0]",             0xCF, 0x01, 0x34, 0x56);
    ONAL("POP", "5635H[0]", "5635H[0]", 0xCF, 0x01, 0x35, 0x56);

    TEST("PUSHF", "", 0xF2);
    TEST("POPF",  "", 0xF3);

    if (is80196()) {
        TEST("XCH", "52, 32",         0x04, 0x20, 0x34);
        TEST("XCH", "86, 52[32]",     0x0B, 0x20, 0x34, 0x56);
        TEST("XCH", "120, 5634H[32]", 0x0B, 0x21, 0x34, 0x56, 0x78);
        TEST("XCH", "120, 5634H[0]",  0x0B, 0x01, 0x34, 0x56, 0x78);
        ONAL("XCH", "120, 5635H[0]",  "5635H[0]", 0x0B, 0x01, 0x35, 0x56, 0x78);

        TEST("XCHB", "52, 32",         0x14, 0x20, 0x34);
        TEST("XCHB", "86, 52[32]",     0x1B, 0x20, 0x34, 0x56);
        TEST("XCHB", "120, 5634H[32]", 0x1B, 0x21, 0x34, 0x56, 0x78);
        TEST("XCHB", "120, 5634H[0]",  0x1B, 0x01, 0x34, 0x56, 0x78);
        TEST("XCHB", "120, 5635H[0]",  0x1B, 0x01, 0x35, 0x56, 0x78);

        TEST("BMOV",  "52, 32", 0xC1, 0x20, 0x34);
        TEST("BMOVI", "52, 32", 0xCD, 0x20, 0x34);

        TEST("PUSHA", "", 0xF4);
        TEST("POPA",  "", 0xF5);
    }
}

void test_jump() {
    ATEST(0x2000, "SJMP", "2002H",  0x20, 0x00);
    ATEST(0x2000, "SJMP", "2200H",  0x21, 0xFE);
    ATEST(0x2000, "SJMP", "2202H",  0x22, 0x00);
    ATEST(0x2000, "SJMP", "2401H",  0x23, 0xFF);
    ATEST(0x2000, "SJMP", "1C02H",  0x24, 0x00);
    ATEST(0x2000, "SJMP", "1E00H",  0x25, 0xFE);
    ATEST(0x2000, "SJMP", "1E02H",  0x26, 0x00);
    ATEST(0x2000, "SJMP", "2000H",  0x27, 0xFE);

    ATEST(0x2000, "LJMP", "2003H",  0xE7, 0x00, 0x00);
    ATEST(0x2000, "LJMP", "0A002H", 0xE7, 0xFF, 0x7F);
    AERRT(0x2000, "LJMP", "0A003H",
          OVERFLOW_RANGE, "0A003H", 0xE7, 0x00, 0x80);
    ATEST(0xA000, "LJMP", "2003H",  0xE7, 0x00, 0x80);
    AERRT(0xA000, "LJMP", "2002H",
          OVERFLOW_RANGE, "2002H",  0xE7, 0xFF, 0x7F);
    ATEST(0x2000, "LJMP", "2103H",  0xE7, 0x00, 0x01);
    ATEST(0x2000, "LJMP", "2400H",  0xE7, 0xFD, 0x03);
    ATEST(0x2000, "LJMP", "2003H",  0xE7, 0x00, 0x00);
    ATEST(0x2000, "LJMP", "2003H",  0xE7, 0x00, 0x00);
    ATEST(0xA000, "LJMP", "2003H",  0xE7, 0x00, 0x80);
    ATEST(0x2000, "LJMP", "2000H",  0xE7, 0xFD, 0xFF);

    ATEST(0x2000, "SCALL", "2002H", 0x28, 0x00);
    ATEST(0x2000, "SCALL", "2200H", 0x29, 0xFE);
    ATEST(0x2000, "SCALL", "2202H", 0x2A, 0x00);
    ATEST(0x2000, "SCALL", "2401H", 0x2B, 0xFF);
    ATEST(0x2000, "SCALL", "1C02H", 0x2C, 0x00);
    ATEST(0x2000, "SCALL", "1E00H", 0x2D, 0xFE);
    ATEST(0x2000, "SCALL", "1E02H", 0x2E, 0x00);
    ATEST(0x2000, "SCALL", "2000H", 0x2F, 0xFE);

    ATEST(0x2000, "LCALL", "2003H",  0xEF, 0x00, 0x00);
    ATEST(0x2000, "LCALL", "0A002H", 0xEF, 0xFF, 0x7F);
    ATEST(0x2000, "LCALL", "2103H",  0xEF, 0x00, 0x01);
    ATEST(0x2000, "LCALL", "2400H",  0xEF, 0xFD, 0x03);
    ATEST(0x2000, "LCALL", "2003H",  0xEF, 0x00, 0x00);
    ATEST(0x2000, "LCALL", "2003H",  0xEF, 0x00, 0x00);
    ATEST(0xA000, "LCALL", "2003H",  0xEF, 0x00, 0x80);
    AERRT(0xA000, "LCALL", "2002H",
          OVERFLOW_RANGE, "2002H",   0xEF, 0xFF, 0x7F);
    ATEST(0x2000, "LCALL", "0A002H", 0xEF, 0xFF, 0x7F);
    AERRT(0x2000, "LCALL", "0A003H",
          OVERFLOW_RANGE, "0A003H",  0xEF, 0x00, 0x80);
    ATEST(0x2000, "LCALL", "2000H",  0xEF, 0xFD, 0xFF);

    TEST("BR", "[32]",         0xE3, 0x20);
    ONAL("BR", "[33]", "[33]", 0xE3, 0x21);
    TEST("RET", "", 0xF0);

    ATEST(0x2000, "JNST", "2002H", 0xD0, 0x00);
    ATEST(0x2000, "JNH",  "2000H", 0xD1, 0xFE);
    ATEST(0x2000, "JGT",  "2081H", 0xD2, 0x7F);
    ATEST(0x2000, "JNC",  "1F82H", 0xD3, 0x80);
    ATEST(0x2000, "JNVT", "2002H", 0xD4, 0x00);
    ATEST(0x2000, "JNV",  "2000H", 0xD5, 0xFE);
    ATEST(0x2000, "JGE",  "2002H", 0xD6, 0x00);
    ATEST(0x2000, "JNE",  "2000H", 0xD7, 0xFE);
    ATEST(0x2000, "JST",  "2002H", 0xD8, 0x00);
    ATEST(0x2000, "JH",   "2000H", 0xD9, 0xFE);
    ATEST(0x2000, "JLE",  "2002H", 0xDA, 0x00);
    ATEST(0x2000, "JC",   "2001H", 0xDB, 0xFF);
    ATEST(0x2000, "JVT",  "2002H", 0xDC, 0x00);
    ATEST(0x2000, "JV",   "2000H", 0xDD, 0xFE);
    ATEST(0x2000, "JLT",  "2002H", 0xDE, 0x00);
    ATEST(0x2000, "JE",   "2000H", 0xDF, 0xFE);

    ATEST(0x2000, "DJNZ", "18, 2000H", 0xE0, 0x12, 0xFD);
    ATEST(0x2000, "DJNZ", "18, 2082H", 0xE0, 0x12, 0x7F);
    ATEST(0x2000, "DJNZ", "18, 1F83H", 0xE0, 0x12, 0x80);
    ATEST(0x2000, "DJNZ", "18, 2003H", 0xE0, 0x12, 0x00);

    if (is80196()) {
        ATEST(0x2000, "DJNZW", "18, 2000H", 0xE1, 0x12, 0xFD);
        ATEST(0x2000, "DJNZW", "18, 2082H", 0xE1, 0x12, 0x7F);
        ATEST(0x2000, "DJNZW", "18, 1F83H", 0xE1, 0x12, 0x80);
        ATEST(0x2000, "DJNZW", "18, 2003H", 0xE1, 0x12, 0x00);
    }

    ATEST(0x2000, "JBC", "18, 0, 2000H", 0x30, 0x12, 0xFD);
    ATEST(0x2000, "JBC", "18, 1, 2082H", 0x31, 0x12, 0x7F);
    ATEST(0x2000, "JBC", "18, 2, 1F83H", 0x32, 0x12, 0x80);
    ATEST(0x2000, "JBC", "18, 3, 2003H", 0x33, 0x12, 0x00);
    ATEST(0x2000, "JBC", "18, 4, 2000H", 0x34, 0x12, 0xFD);
    ATEST(0x2000, "JBC", "18, 5, 2082H", 0x35, 0x12, 0x7F);
    ATEST(0x2000, "JBC", "18, 6, 1F83H", 0x36, 0x12, 0x80);
    ATEST(0x2000, "JBC", "18, 7, 2003H", 0x37, 0x12, 0x00);
    ATEST(0x2000, "JBS", "18, 0, 2000H", 0x38, 0x12, 0xFD);
    ATEST(0x2000, "JBS", "18, 1, 2082H", 0x39, 0x12, 0x7F);
    ATEST(0x2000, "JBS", "18, 2, 1F83H", 0x3A, 0x12, 0x80);
    ATEST(0x2000, "JBS", "18, 3, 2003H", 0x3B, 0x12, 0x00);
    ATEST(0x2000, "JBS", "18, 4, 2000H", 0x3C, 0x12, 0xFD);
    ATEST(0x2000, "JBS", "18, 5, 2082H", 0x3D, 0x12, 0x7F);
    ATEST(0x2000, "JBS", "18, 6, 1F83H", 0x3E, 0x12, 0x80);
    ATEST(0x2000, "JBS", "18, 7, 2003H", 0x3F, 0x12, 0x00);

    if (is80196()) {
        TEST("TIJMP", "86, 32, #15", 0xE2, 0x20, 0x0F, 0x56);
    }
}

void test_jump_relative() {
    disassembler.setOption("relative", "on");

    ATEST(0x2000, "SJMP", "$+2",     0x20, 0x00);
    ATEST(0x2000, "SJMP", "$+512",   0x21, 0xFE);
    ATEST(0x2000, "SJMP", "$+514",   0x22, 0x00);
    ATEST(0x2000, "SJMP", "$+1025",  0x23, 0xFF);
    ATEST(0x2000, "SJMP", "$-1022",  0x24, 0x00);
    ATEST(0x2000, "SJMP", "$-512",   0x25, 0xFE);
    ATEST(0x2000, "SJMP", "$-510",   0x26, 0x00);
    ATEST(0x2000, "SJMP", "$",       0x27, 0xFE);
    ATEST(0x2000, "LJMP", "$+3",                                0xE7, 0x00, 0x00);
    ATEST(0x2000, "LJMP", "$+8002H",                            0xE7, 0xFF, 0x7F);
    AERRT(0x9000, "LJMP", "$+8002H", OVERFLOW_RANGE, "$+8002H", 0xE7, 0xFF, 0x7F);
    ATEST(0x2000, "LJMP", "$+0103H",                            0xE7, 0x00, 0x01);
    ATEST(0x2000, "LJMP", "$+0400H",                            0xE7, 0xFD, 0x03);
    ATEST(0x2000, "LJMP", "$+3",                                0xE7, 0x00, 0x00);
    ATEST(0xA000, "LJMP", "$-7FFDH",                            0xE7, 0x00, 0x80);
    AERRT(0xA000, "LJMP", "$+8002H", OVERFLOW_RANGE, "$+8002H", 0xE7, 0xFF, 0x7F);
    ATEST(0x2000, "LJMP", "$",                                  0xE7, 0xFD, 0xFF);
    ATEST(0x2000, "SCALL", "$+2",    0x28, 0x00);
    ATEST(0x2000, "SCALL", "$+512",  0x29, 0xFE);
    ATEST(0x2000, "SCALL", "$+514",  0x2A, 0x00);
    ATEST(0x2000, "SCALL", "$+1025", 0x2B, 0xFF);
    ATEST(0x2000, "SCALL", "$-1022", 0x2C, 0x00);
    ATEST(0x2000, "SCALL", "$-512",  0x2D, 0xFE);
    ATEST(0x2000, "SCALL", "$-510",  0x2E, 0x00);
    ATEST(0x2000, "SCALL", "$",      0x2F, 0xFE);
    ATEST(0x2000, "LCALL", "$+3",                                0xEF, 0x00, 0x00);
    ATEST(0x2000, "LCALL", "$+8002H",                            0xEF, 0xFF, 0x7F);
    AERRT(0x2000, "LCALL", "$-7FFDH", OVERFLOW_RANGE, "$-7FFDH", 0xEF, 0x00, 0x80);
    ATEST(0x2000, "LCALL", "$+0103H",                            0xEF, 0x00, 0x01);
    ATEST(0x2000, "LCALL", "$+0400H",                            0xEF, 0xFD, 0x03);
    ATEST(0x2000, "LCALL", "$+3",                                0xEF, 0x00, 0x00);
    ATEST(0xA000, "LCALL", "$-7FFDH",                            0xEF, 0x00, 0x80);
    AERRT(0xA000, "LCALL", "$+8002H", OVERFLOW_RANGE, "$+8002H", 0xEF, 0xFF, 0x7F);
    ATEST(0x2000, "LCALL", "$",                                  0xEF, 0xFD, 0xFF);

    ATEST(0x2000, "JNST", "$+2",  0xD0, 0x00);
    ATEST(0x2000, "JNH",  "$",    0xD1, 0xFE);
    ATEST(0x2000, "JGT",  "$+2",  0xD2, 0x00);
    ATEST(0x2000, "JNC",  "$+1",  0xD3, 0xFF);
    ATEST(0x2000, "JNVT", "$+2",  0xD4, 0x00);
    ATEST(0x2000, "JNV",  "$",    0xD5, 0xFE);
    ATEST(0x2000, "JGE",  "$+2",  0xD6, 0x00);
    ATEST(0x2000, "JNE",  "$",    0xD7, 0xFE);
    ATEST(0x2000, "JST",  "$+2",  0xD8, 0x00);
    ATEST(0x2000, "JH",   "$",    0xD9, 0xFE);
    ATEST(0x2000, "JLE",  "$+2",  0xDA, 0x00);
    ATEST(0x2000, "JC",   "$+1",  0xDB, 0xFF);
    ATEST(0x2000, "JVT",  "$+2",  0xDC, 0x00);
    ATEST(0x2000, "JV",   "$",    0xDD, 0xFE);
    ATEST(0x2000, "JLT",  "$+2",  0xDE, 0x00);
    ATEST(0x2000, "JE",   "$",    0xDF, 0xFE);

    ATEST(0x2000, "DJNZ", "18, $",     0xE0, 0x12, 0xFD);
    ATEST(0x2000, "DJNZ", "18, $+130", 0xE0, 0x12, 0x7F);
    ATEST(0x2000, "DJNZ", "18, $-125", 0xE0, 0x12, 0x80);
    ATEST(0x2000, "DJNZ", "18, $+3",   0xE0, 0x12, 0x00);

    ATEST(0x2000, "JBC", "18, 0, $",     0x30, 0x12, 0xFD);
    ATEST(0x2000, "JBC", "18, 1, $+130", 0x31, 0x12, 0x7F);
    ATEST(0x2000, "JBC", "18, 2, $-125", 0x32, 0x12, 0x80);
    ATEST(0x2000, "JBC", "18, 3, $+3",   0x33, 0x12, 0x00);
    ATEST(0x2000, "JBC", "18, 4, $",     0x34, 0x12, 0xFD);
    ATEST(0x2000, "JBC", "18, 5, $+130", 0x35, 0x12, 0x7F);
    ATEST(0x2000, "JBC", "18, 6, $-125", 0x36, 0x12, 0x80);
    ATEST(0x2000, "JBC", "18, 7, $+3",   0x37, 0x12, 0x00);
    ATEST(0x2000, "JBS", "18, 0, $",     0x38, 0x12, 0xFD);
    ATEST(0x2000, "JBS", "18, 1, $+130", 0x39, 0x12, 0x7F);
    ATEST(0x2000, "JBS", "18, 2, $-125", 0x3A, 0x12, 0x80);
    ATEST(0x2000, "JBS", "18, 3, $+3",   0x3B, 0x12, 0x00);
    ATEST(0x2000, "JBS", "18, 4, $",     0x3C, 0x12, 0xFD);
    ATEST(0x2000, "JBS", "18, 5, $+130", 0x3D, 0x12, 0x7F);
    ATEST(0x2000, "JBS", "18, 6, $-125", 0x3E, 0x12, 0x80);
    ATEST(0x2000, "JBS", "18, 7, $+3",   0x3F, 0x12, 0x00);
}

void test_modify() {
    TEST("DEC",  "6",                           0x05, 0x06);
    ONAL("DEC",  "7", "7", 0x05, 0x07);
    TEST("DECB", "6", 0x15, 0x06);
    TEST("DECB", "7", 0x15, 0x07);
    TEST("INC",  "8", 0x07, 0x08);
    TEST("INCB", "9", 0x17, 0x09);
    TEST("EXT",  "8", 0x06, 0x08);
    ONAL("EXT",  "9", "9",  0x06, 0x09);
    ONAL("EXT", "10", "10", 0x06, 0x0A);
    ONAL("EXT", "11", "11", 0x06, 0x0B);
    TEST("EXTB", "6",                            0x16, 0x06);
    ONAL("EXTB", "7", "7",  0x16, 0x07);
    TEST("NOT",  "8", 0x02, 0x08);
    TEST("NOTB", "9", 0x12, 0x09);
    TEST("CLR",  "6", 0x01, 0x06);
    TEST("CLRB", "7", 0x11, 0x07);

    TEST("SHL",  "10, #15",                                0x09, 0x0F, 0x0A);
    TEST("SHL",  "10, 16",                                 0x09, 0x10, 0x0A);
    TEST("SHL",  "10, 17",                                 0x09, 0x11, 0x0A);
    ONAL("SHL",  "11, 17", "11, 17", 0x09, 0x11, 0x0B);
    TEST("SHLB", "23, #15",                                0x19, 0x0F, 0x17);
    TEST("SHLB", "23, 16",                                 0x19, 0x10, 0x17);
    TEST("SHLB", "23, 17",                                 0x19, 0x11, 0x17);
    TEST("SHLL", "24, #15",                                0x0D, 0x0F, 0x18);
    TEST("SHLL", "24, 16",                                 0x0D, 0x10, 0x18);
    TEST("SHLL", "24, 17",                                 0x0D, 0x11, 0x18);
    ONAL("SHLL", "25, 17", "25, 17", 0x0D, 0x11, 0x19);
    ONAL("SHLL", "26, 17", "26, 17", 0x0D, 0x11, 0x1A);
    ONAL("SHLL", "27, 17", "27, 17", 0x0D, 0x11, 0x1B);

    TEST("SHR",  "10, #15", 0x08, 0x0F, 0x0A);
    TEST("SHR",  "10, 16",  0x08, 0x10, 0x0A);
    TEST("SHRB", "23, #15", 0x18, 0x0F, 0x17);
    TEST("SHRB", "23, 16",  0x18, 0x10, 0x17);
    TEST("SHRL", "24, #15", 0x0C, 0x0F, 0x18);
    TEST("SHRL", "24, 16",  0x0C, 0x10, 0x18);

    TEST("SHRA",  "10, #11", 0x0A, 0x0B, 0x0A);
    TEST("SHRA",  "10, 16",  0x0A, 0x10, 0x0A);
    TEST("SHRAB", "23, #11", 0x1A, 0x0B, 0x17);
    TEST("SHRAB", "23, 16",  0x1A, 0x10, 0x17);
    TEST("SHRAL", "24, #11", 0x0E, 0x0B, 0x18);
    TEST("SHRAL", "24, 16",  0x0E, 0x10, 0x18);

    TEST("NORML", "20, 19",                                0x0F, 0x13, 0x14);
    ONAL("NORML", "21, 19", "21, 19", 0x0F, 0x13, 0x15);
    ONAL("NORML", "22, 19", "22, 19", 0x0F, 0x13, 0x16);
    ONAL("NORML", "23, 19", "23, 19", 0x0F, 0x13, 0x17);
}

void test_control() {
    TEST("SETC",  "",  0xF9);
    TEST("CLRC",  "",  0xF8);
    TEST("CLRVT", "",  0xFC);
    TEST("RST",   "",  0xFF);
    TEST("DI",    "",  0xFA);
    TEST("EI",    "",  0xFB);
    TEST("NOP",   "",  0xFD);
    TEST("SKIP",  "1", 0x00, 0x01);
    TEST("TRAP",  "",  0xF7);
    if (is80196()) {
        TEST("DPTS",  "", 0xEC);
        TEST("EPTS",  "", 0xED);
        TEST("IDLPD", "#1", 0xF6, 0x01);
    }
}

void test_absolute() {
    TEST("ADD",  "120, 5634H[0]",      0x67, 0x01, 0x34, 0x56, 0x78);
    TEST("ADD",  "154, 120, 5634H[0]", 0x47, 0x01, 0x34, 0x56, 0x78, 0x9A);
    TEST("LDB",  "235, 0ECEDH[0]",     0xB3, 0x01, 0xED, 0xEC, 0xEB);
    TEST("PUSH", "52",                 0xC8, 0x34);
    TEST("PUSH", "52[0]",              0xCB, 0x00, 0x34);
    TEST("PUSH", "5634H[0]",           0xCB, 0x01, 0x34, 0x56);

    disassembler.setOption("use-absolute", "enable");
    TEST("ADD",  "120, 5634H",         0x67, 0x01, 0x34, 0x56, 0x78);
    TEST("ADD",  "154, 120, 5634H",    0x47, 0x01, 0x34, 0x56, 0x78, 0x9A);
    TEST("LDB",  "235, 0ECEDH",        0xB3, 0x01, 0xED, 0xEC, 0xEB);
    TEST("PUSH", "52",                 0xC8, 0x34);
    TEST("PUSH", "52",                 0xCB, 0x00, 0x34);
    TEST("PUSH", "5634H",              0xCB, 0x01, 0x34, 0x56);
}

void test_illegal_8096() {
    static constexpr Config::opcode_t ILLEGAL[] = {
            0x04, 0x0B,
            0x10, 0x14, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F,
            0xC1, 0xC5, 0xCD,
            0xE1, 0xE2, 0xE4, 0xE5, 0xE6, 0xE8, 0xE9, 0xEA, 0xEB, 0xEC, 0xED, 0xEE,
            0xF1, 0xF4, 0xF5, 0xF6,
    };
    for (auto opc : ILLEGAL)
        UNKN(opc);

    for (auto i = 0; i < 0x100; i++) {
        const Config::opcode_t opc = i;
        const auto h4 = opc & 0xF0;
        const auto l4 = opc & 0xF0;
        if (h4 >= 0x40 && h4 < 0xA0 && l4 >= 0xC)
            continue;
        UNKN(0xFE, opc);
    }
}

void test_illegal_80196() {
    static constexpr Config::opcode_t ILLEGAL[] = {
            0x10, 0x1C, 0x1D, 0x1E, 0x1F,
            0xE4, 0xE5, 0xE6, 0xE8, 0xE9, 0xEA, 0xEB, 0xEE,
            0xF1,
    };
    for (auto opc : ILLEGAL)
        UNKN(opc);

    for (auto i = 0; i < 0x100; i++) {
        const Config::opcode_t opc = i;
        const auto h4 = opc & 0xF0;
        const auto l4 = opc & 0xF0;
        if (h4 >= 0x40 && h4 < 0xA0 && l4 >= 0xC)
            continue;
        UNKN(0xFE, opc);
    }
}

// clang-format on

void run_tests(const char *cpu) {
    disassembler.setCpu(cpu);
    RUN_TEST(test_2_operands);
    RUN_TEST(test_3_operands);
    RUN_TEST(test_move);
    RUN_TEST(test_jump);
    RUN_TEST(test_jump_relative);
    RUN_TEST(test_modify);
    RUN_TEST(test_control);
    RUN_TEST(test_absolute);
    if (is8096())
        RUN_TEST(test_illegal_8096);
    if (is80196())
        RUN_TEST(test_illegal_80196);
}

// Local Variables:
// mode: c++
// c-basic-offset: 4
// tab-width: 4
// End:
// vim: set ft=cpp et ts=4 sw=4:
